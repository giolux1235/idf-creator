# External API SQLite Extraction Specification

## Overview

This document specifies exactly how the external EnergyPlus API should extract energy results from the SQLite database file (`eplusout.sql`) generated by EnergyPlus simulations.

## Current Status

- ✅ SQLite file is being generated (180,224 bytes / 176 KB)
- ✅ Simulation runs successfully
- ❌ Energy results are NOT being extracted from SQLite
- ❌ No `energy_results` field in API response

## Required Response Format

When SQLite extraction succeeds, the API should return:

```json
{
  "version": "33.0.0",
  "simulation_status": "success",
  "energyplus_version": "25.1.0",
  "real_simulation": true,
  "energy_results": {
    "total_site_energy_kwh": 12345.67,
    "total_electricity_kwh": 10000.00,
    "total_gas_kwh": 2345.67,
    "building_area_m2": 4645.15,
    "eui_kwh_m2": 2.66
  },
  "output_files": [...],
  "processing_time": "..."
}
```

## SQLite Database Schema

EnergyPlus SQLite databases use the following key tables:

### Primary Tables:
- `ReportMeterData` - Contains meter readings (values in Joules)
- `ReportMeterDataDictionary` - Dictionary of meter names and metadata
- `ReportVariableData` - Contains variable readings
- `ReportVariableDataDictionary` - Dictionary of variable names

### Alternative Schema (Some versions):
- `ReportMeterData` with `ReportMeterDictionary` (instead of ReportMeterDataDictionary)
- `ReportVariableData` with `ReportVariableDictionary` (instead of ReportVariableDataDictionary)

## Implementation Guide

### Step 1: Open SQLite Database

```python
import sqlite3
import os

sql_file = os.path.join(output_dir, 'eplusout.sql')

if not os.path.exists(sql_file) or os.path.getsize(sql_file) == 0:
    return None  # No SQLite file or empty file

try:
    conn = sqlite3.connect(sql_file)
    cursor = conn.cursor()
except Exception as e:
    # Log error
    return None
```

### Step 2: Extract Electricity Consumption

**Strategy 1: ReportMeterDataDictionary (Primary)**
```sql
SELECT SUM(d.Value) 
FROM ReportMeterData d
JOIN ReportMeterDataDictionary m ON d.ReportMeterDataDictionaryIndex = m.ReportMeterDataDictionaryIndex
WHERE m.Name LIKE '%Electricity%Facility%'
AND m.ReportingFrequency = 'RunPeriod'
```

**Strategy 2: ReportMeterDictionary (Alternative)**
```sql
SELECT SUM(d.Value) 
FROM ReportMeterData d
JOIN ReportMeterDictionary m ON d.ReportMeterDictionaryIndex = m.ReportMeterDictionaryIndex
WHERE m.Name LIKE '%Electricity%Facility%'
AND m.ReportingFrequency = 'RunPeriod'
```

**Strategy 3: Direct Lookup ReportMeterDataDictionary**
```sql
SELECT SUM(Value) 
FROM ReportMeterData
WHERE ReportMeterDataDictionaryIndex IN (
    SELECT ReportMeterDataDictionaryIndex
    FROM ReportMeterDataDictionary
    WHERE Name = 'Electricity:Facility'
    AND ReportingFrequency = 'RunPeriod'
)
```

**Strategy 4: Direct Lookup ReportMeterDictionary**
```sql
SELECT SUM(Value) 
FROM ReportMeterData
WHERE ReportMeterDictionaryIndex IN (
    SELECT ReportMeterDictionaryIndex
    FROM ReportMeterDictionary
    WHERE Name = 'Electricity:Facility'
    AND ReportingFrequency = 'RunPeriod'
)
```

**Strategy 5: Generic Electricity Search**
```sql
SELECT SUM(Value) 
FROM ReportMeterData
WHERE ReportMeterDataDictionaryIndex IN (
    SELECT ReportMeterDataDictionaryIndex
    FROM ReportMeterDataDictionary
    WHERE Name LIKE '%Electricity%'
    AND ReportingFrequency = 'RunPeriod'
)
```

### Step 3: Extract Natural Gas Consumption

**Strategy 1: NaturalGas:Facility with ReportMeterDataDictionary**
```sql
SELECT SUM(d.Value) 
FROM ReportMeterData d
JOIN ReportMeterDataDictionary m ON d.ReportMeterDataDictionaryIndex = m.ReportMeterDataDictionaryIndex
WHERE m.Name LIKE '%NaturalGas%Facility%'
AND m.ReportingFrequency = 'RunPeriod'
```

**Strategy 2: NaturalGas:Facility with ReportMeterDictionary**
```sql
SELECT SUM(d.Value) 
FROM ReportMeterData d
JOIN ReportMeterDictionary m ON d.ReportMeterDictionaryIndex = m.ReportMeterDictionaryIndex
WHERE m.Name LIKE '%NaturalGas%Facility%'
AND m.ReportingFrequency = 'RunPeriod'
```

**Strategy 3: Generic Gas Search**
```sql
SELECT SUM(Value) 
FROM ReportMeterData
WHERE ReportMeterDataDictionaryIndex IN (
    SELECT ReportMeterDataDictionaryIndex
    FROM ReportMeterDataDictionary
    WHERE Name LIKE '%Gas%'
    AND ReportingFrequency = 'RunPeriod'
)
```

### Step 4: Extract Building Area

**Strategy 1: Floor Area with ReportVariableDataDictionary**
```sql
SELECT SUM(Value) 
FROM ReportVariableData d
JOIN ReportVariableDataDictionary v ON d.ReportVariableDataDictionaryIndex = v.ReportVariableDataDictionaryIndex
WHERE v.Name LIKE '%Floor Area%'
AND v.ReportingFrequency = 'RunPeriod'
LIMIT 1
```

**Strategy 2: Floor Area with ReportVariableDictionary**
```sql
SELECT SUM(Value) 
FROM ReportVariableData d
JOIN ReportVariableDictionary v ON d.ReportVariableDictionaryIndex = v.ReportVariableDictionaryIndex
WHERE v.Name LIKE '%Floor Area%'
AND v.ReportingFrequency = 'RunPeriod'
LIMIT 1
```

**Strategy 3: Building Area Search**
```sql
SELECT Value 
FROM ReportVariableData
WHERE ReportVariableDataDictionaryIndex IN (
    SELECT ReportVariableDataDictionaryIndex
    FROM ReportVariableDataDictionary
    WHERE Name LIKE '%Building%Area%'
    AND ReportingFrequency = 'RunPeriod'
)
LIMIT 1
```

## Complete Python Implementation

```python
def extract_energy_from_sqlite(sql_file_path: str) -> dict:
    """
    Extract energy results from EnergyPlus SQLite database
    
    Returns:
        dict with energy_results or None if extraction fails
    """
    import sqlite3
    import os
    
    if not os.path.exists(sql_file_path) or os.path.getsize(sql_file_path) == 0:
        return None
    
    try:
        conn = sqlite3.connect(sql_file_path)
        cursor = conn.cursor()
        
        energy_results = {}
        total_site_energy_j = 0
        
        # ELECTRICITY EXTRACTION - Try multiple strategies
        electricity_queries = [
            # Strategy 1: ReportMeterDataDictionary
            """
            SELECT SUM(d.Value) 
            FROM ReportMeterData d
            JOIN ReportMeterDataDictionary m ON d.ReportMeterDataDictionaryIndex = m.ReportMeterDataDictionaryIndex
            WHERE m.Name LIKE '%Electricity%Facility%'
            AND m.ReportingFrequency = 'RunPeriod'
            """,
            # Strategy 2: ReportMeterDictionary
            """
            SELECT SUM(d.Value) 
            FROM ReportMeterData d
            JOIN ReportMeterDictionary m ON d.ReportMeterDictionaryIndex = m.ReportMeterDictionaryIndex
            WHERE m.Name LIKE '%Electricity%Facility%'
            AND m.ReportingFrequency = 'RunPeriod'
            """,
            # Strategy 3: Direct lookup
            """
            SELECT SUM(Value) 
            FROM ReportMeterData
            WHERE ReportMeterDataDictionaryIndex IN (
                SELECT ReportMeterDataDictionaryIndex
                FROM ReportMeterDataDictionary
                WHERE Name = 'Electricity:Facility'
                AND ReportingFrequency = 'RunPeriod'
            )
            """,
            # Strategy 4: Alternative direct lookup
            """
            SELECT SUM(Value) 
            FROM ReportMeterData
            WHERE ReportMeterDictionaryIndex IN (
                SELECT ReportMeterDictionaryIndex
                FROM ReportMeterDictionary
                WHERE Name = 'Electricity:Facility'
                AND ReportingFrequency = 'RunPeriod'
            )
            """,
            # Strategy 5: Generic search
            """
            SELECT SUM(Value) 
            FROM ReportMeterData
            WHERE ReportMeterDataDictionaryIndex IN (
                SELECT ReportMeterDataDictionaryIndex
                FROM ReportMeterDataDictionary
                WHERE Name LIKE '%Electricity%'
                AND ReportingFrequency = 'RunPeriod'
            )
            """
        ]
        
        # Try each electricity query until one works
        for query in electricity_queries:
            try:
                cursor.execute(query)
                result = cursor.fetchone()
                if result and result[0] and result[0] > 0:
                    total_site_energy_j = float(result[0])
                    break
            except Exception:
                continue
        
        # If we got electricity, convert and add to results
        if total_site_energy_j > 0:
            # Value is in Joules, convert to kWh (1 kWh = 3,600,000 J)
            energy_results['total_electricity_kwh'] = total_site_energy_j / 3600000.0
            energy_results['total_site_energy_kwh'] = total_site_energy_j / 3600000.0
            energy_results['total_site_energy_j'] = total_site_energy_j
            
            # Try to get natural gas
            gas_queries = [
                """
                SELECT SUM(d.Value) 
                FROM ReportMeterData d
                JOIN ReportMeterDataDictionary m ON d.ReportMeterDataDictionaryIndex = m.ReportMeterDataDictionaryIndex
                WHERE m.Name LIKE '%NaturalGas%Facility%'
                AND m.ReportingFrequency = 'RunPeriod'
                """,
                """
                SELECT SUM(d.Value) 
                FROM ReportMeterData d
                JOIN ReportMeterDictionary m ON d.ReportMeterDictionaryIndex = m.ReportMeterDictionaryIndex
                WHERE m.Name LIKE '%NaturalGas%Facility%'
                AND m.ReportingFrequency = 'RunPeriod'
                """,
                """
                SELECT SUM(Value) 
                FROM ReportMeterData
                WHERE ReportMeterDataDictionaryIndex IN (
                    SELECT ReportMeterDataDictionaryIndex
                    FROM ReportMeterDataDictionary
                    WHERE Name LIKE '%Gas%'
                    AND ReportingFrequency = 'RunPeriod'
                )
                """
            ]
            
            total_gas_j = 0
            for query in gas_queries:
                try:
                    cursor.execute(query)
                    result = cursor.fetchone()
                    if result and result[0] and result[0] > 0:
                        total_gas_j = float(result[0])
                        break
                except Exception:
                    continue
            
            if total_gas_j > 0:
                # Gas is typically in Joules, convert to kWh
                energy_results['total_gas_kwh'] = total_gas_j / 3600000.0
                # Add gas to total site energy
                energy_results['total_site_energy_kwh'] += energy_results['total_gas_kwh']
        
        # Extract building area
        area_queries = [
            """
            SELECT SUM(Value) 
            FROM ReportVariableData d
            JOIN ReportVariableDataDictionary v ON d.ReportVariableDataDictionaryIndex = v.ReportVariableDataDictionaryIndex
            WHERE v.Name LIKE '%Floor Area%'
            AND v.ReportingFrequency = 'RunPeriod'
            LIMIT 1
            """,
            """
            SELECT SUM(Value) 
            FROM ReportVariableData d
            JOIN ReportVariableDictionary v ON d.ReportVariableDictionaryIndex = v.ReportVariableDictionaryIndex
            WHERE v.Name LIKE '%Floor Area%'
            AND v.ReportingFrequency = 'RunPeriod'
            LIMIT 1
            """,
            """
            SELECT Value 
            FROM ReportVariableData
            WHERE ReportVariableDataDictionaryIndex IN (
                SELECT ReportVariableDataDictionaryIndex
                FROM ReportVariableDataDictionary
                WHERE Name LIKE '%Building%Area%'
                AND ReportingFrequency = 'RunPeriod'
            )
            LIMIT 1
            """
        ]
        
        for query in area_queries:
            try:
                cursor.execute(query)
                area_result = cursor.fetchone()
                if area_result and area_result[0] and area_result[0] > 0:
                    area = float(area_result[0])
                    if area > 0:
                        energy_results['building_area_m2'] = area
                        if energy_results.get('total_site_energy_kwh'):
                            energy_results['eui_kwh_m2'] = (
                                energy_results['total_site_energy_kwh'] / area
                            )
                        break
            except Exception:
                continue
        
        conn.close()
        
        # Only return results if we got at least energy data
        if energy_results.get('total_site_energy_kwh'):
            return energy_results
        
        return None
        
    except Exception as e:
        # Log error but don't fail
        print(f"SQLite extraction error: {e}")
        return None
```

## Integration into API Response

### In the /simulate endpoint:

```python
# After EnergyPlus simulation completes and SQLite file is generated
sql_file = os.path.join(output_dir, 'eplusout.sql')

energy_results = None

# Try CSV first (if it exists)
if os.path.exists(csv_file):
    energy_results = extract_from_csv(csv_file)

# If CSV doesn't work, try SQLite
if not energy_results and os.path.exists(sql_file):
    energy_results = extract_energy_from_sqlite(sql_file)

# Build response
if energy_results:
    return jsonify({
        'version': '33.0.0',
        'simulation_status': 'success',  # ✅ Change to success!
        'energyplus_version': '25.1.0',
        'real_simulation': True,
        'energy_results': energy_results,  # ✅ Include results!
        'output_files': output_files_list,
        'processing_time': datetime.now().isoformat()
    }), 200
else:
    return jsonify({
        'version': '33.0.0',
        'simulation_status': 'error',
        'error_message': 'EnergyPlus ran but produced no energy results...',
        'output_files': output_files_list,
        'processing_time': datetime.now().isoformat()
    }), 200
```

## Key Points

1. **Try Multiple Query Strategies**: Different EnergyPlus versions may use different table schemas
2. **Convert Joules to kWh**: EnergyPlus stores values in Joules, convert using: `kWh = Joules / 3,600,000`
3. **Handle Missing Data**: If electricity extraction fails, return None
4. **Calculate EUI**: Energy Use Intensity = Total Energy / Building Area
5. **Change Status to Success**: When results are extracted, set `simulation_status: "success"`

## Testing

After implementation, test with:
1. Check if SQLite file exists and has size > 0
2. Try opening the database
3. Execute queries and check results
4. Verify energy_results are in response
5. Verify simulation_status is "success"

## Expected Results

Once implemented, the API should return:
- `simulation_status: "success"` (not "error")
- `energy_results` field with:
  - `total_site_energy_kwh`
  - `total_electricity_kwh`
  - `building_area_m2` (if available)
  - `eui_kwh_m2` (if area available)

## Notes

- EnergyPlus values are in **Joules** - must convert to kWh
- Some simulations may not have gas consumption
- Building area may not always be available
- EUI calculation requires both energy and area







